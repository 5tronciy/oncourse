apply plugin: 'groovy'
apply plugin: 'java-library'

configurations {
    swagger
}

sourceSets.main.java.srcDirs = []
sourceSets.main.groovy.srcDir 'src/main/java'
sourceSets.test.java.srcDirs = []
sourceSets.test.groovy.srcDir 'src/test/java'

apply from: "$rootDir/gradle/bootique.gradle"

sourceCompatibility = 8
targetCompatibility = 11

dependencies {

    api (project(':common')) {
        exclude group: 'org.bouncycastle'
        exclude module: "hessian"
        exclude group: "org.slf4j", module: "slf4j-simple"
    }

    api 'io.swagger:swagger-annotations:1.5.21'
    api "org.codehaus.groovy:groovy-all:$groovyVersion"

    api "org.apache.cxf:cxf-core:$cfxVersion"
    api "org.apache.cxf:cxf-rt-frontend-jaxrs:$cfxVersion"

    api 'javax.validation:validation-api:1.1.0.Final'
    api 'org.apache.bval:org.apache.bval.bundle:1.1.2'

    //latest jackson 2.9.9 conflicts with spring AbstractApplicationContext
    api "com.fasterxml.jackson.jaxrs:jackson-jaxrs-json-provider:2.8.7"
    api "com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.8.7"
}

sourceSets {
    main {
        groovy {
            srcDirs += "${project.projectDir}/build/generated-sources/src/main/groovy"
        }
    }
}

test {
//    forkEvery = 1 //run every test in separate jvm
//    initTestDBConfig(project, test)
}

tasks.withType(GroovyCompile).configureEach {
    options.incremental = true
}
compileGroovy.groovyOptions.configurationScript = file("${rootDir}/gradle/groovyConfig.groovy")


task swagger (type: Swagger) {
    schema = file("${project.projectDir}/src/main/resources/server-api.yaml")
    schemaVersion = 1
    javaOutput = file("${project.projectDir}/build/generated-sources")
    jsOutput = file("${rootDir}/client-html/build/generated-sources")
}

compileGroovy {
    dependsOn swagger
    groovyClasspath += classpath.filter { it.absolutePath.contains('jaxb-api') }
}

clean.doFirst {
    delete("${project.projectDir}/build/generated-sources")
}
